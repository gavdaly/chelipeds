{
  "ref": "chelipeds/42/x86_64/hyperland-dev",
  "repos": ["fedora", "fedora-updates"],
  "selinux": true,
  "automatic-version-prefix": "42",
  "releasever": "42",
  "bootstrap-package": "basesystem",
  "packages": [
    // Hyprland desktop
    "hyperland",
    "waybar",
    "wofi",
    "mako",
    "wl-clipboard",
    "grim",
    "slurp",
    "swappy",
    "swaybg",
    "swaylock",
    "xdg-desktop-portal-wlr",
    "xdg-desktop-portal-gtk",
    "nerd-fonts",
    "ghostty",
    "kitty",

    // Dev stack
    "neovim",
    "gcc",
    "gcc-c++",
    "clang",
    "cmake",
    "ninja-build",
    "make",
    "gdb",
    "git",

    // Containers
    "podman",
    "podman-compose",
    "buildah",
    "skopeo",
    "crun",
    "podman-tui",
    "podman-desktop",
    "toolbox",
    "distrobox",

    // Flatpak base
    "flatpak",

    // Networking/system
    "curl",
    "wget",
    "rsync",
    "jq",
    "htop",
    "strace",
    "lsof",
    "tcpdump",
    "traceroute",
    "tailscale",
    "nfs-utils",
    "mosh",
    "wireguard-tools",

    // Login manager
    "ly"
  ],
  "default-target": "graphical.target",
  "postprocess": [
    {
      "type": "script",
      "commands": [
        // Flathub
        "flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo",

        // Core Flatpaks
        "flatpak install -y flathub io.github.kolunmi.Bazaar",
        "flatpak install -y flathub io.github.flattool.Warehouse",
        "flatpak install -y flathub io.github.zaedus.spider",

        "flatpak install -y flathub org.mozilla.firefox",
        "flatpak install -y flathub org.gnome.Epiphany",
        "flatpak install -y flathub org.chromium.Chromium",

        "flatpak install -y flathub dev.zed.Zed",
        "flatpak install -y flathub com.visualstudio.code",
        "flatpak install -y flathub io.loft.DevPod",

        // Flatpak overrides: Wayland, GPU, home
        "curl -L -o /tmp/flow-browser.flatpak https://github.com/MultiboxLabs/flow-browser/releases/download/v0.8.3/flow-browser-0.8.3-x86_64.flatpak",
        "flatpak install -y /tmp/flow-browser.flatpak",
        "rm /tmp/flow-browser.flatpak",

        "flatpak override --user --socket=wayland --device=dri --filesystem=home io.github.kolunmi.Bazaar",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home io.github.flattool.Warehouse",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home io.github.zaedus.spider",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home org.mozilla.firefox",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home org.gnome.Epiphany",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home org.chromium.Chromium",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home dev.zed.Zed",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home com.visualstudio.code",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home io.loft.DevPod",
        "flatpak override --user --socket=wayland --device=dri --filesystem=home org.flow_browser.Flow",

        "install -d /usr/local/bin",
        "ln -sf /var/lib/flatpak/exports/bin/dev.zed.Zed /usr/local/bin/zed",
        "ln -sf /var/lib/flatpak/exports/bin/com.visualstudio.code /usr/local/bin/code",
        "ln -sf /var/lib/flatpak/exports/bin/io.loft.DevPod /usr/local/bin/devpod",

        // Rust + cargo-binstall
        "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y",
        "cargo install cargo-binstall || true",

        // Python (uv) + latest Python
        "curl -LsSf https://astral.sh/uv/install.sh | sh",
        "uv python install latest",
        "uv python pin latest",

        // Node.js via Volta + common CLIs
        "curl https://get.volta.sh | bash",
        "volta install @anthropic-ai/claude-code @google/gemini-cli @openai/codex",
        "volta install typescript ts-node eslint prettier npm-check-updates vite vitest jest nodemon http-server",

        // Rust CLIs via cargo-binstall
        "cargo binstall -y just cargo-update cargo-edit cargo-watch cargo-nextest",
        "cargo binstall -y fzf ripgrep fd-find bat yq eza bottom btop bandwhich gitui lazygit yazi nnn ranger",
        "cargo binstall -y tokei kmon lazydocker dua-cli dust broot procs tealdeer xh gping",
        "cargo binstall -y eva pastel hyperfine starship zellij jj lazyjj",

        // ### Automation & Maintenance (systemd timers)
        // Create update-tools script
        "cat <<'EOF' > /usr/local/bin/update-tools.sh",
        "#!/usr/bin/env bash",
        "set -euxo pipefail",
        "export PATH=\"$HOME/.cargo/bin:$HOME/.local/bin:$HOME/.volta/bin:$PATH\"",
        "rustup update || true",
        "cargo install-update -a || true",
        "uv python install latest && uv python pin latest || true",
        "volta install node@latest || true",
        "volta install npm-check-updates eslint prettier typescript ts-node vite vitest jest nodemon http-server || true",
        "EOF",
        "chmod +x /usr/local/bin/update-tools.sh",

        // systemd service for update-tools
        "cat <<'EOF' > /etc/systemd/system/update-tools.service",
        "[Unit]",
        "Description=Update Rust, Node, Python, and CLI tools",
        "",
        "[Service]",
        "Type=oneshot",
        "ExecStart=/usr/local/bin/update-tools.sh",
        "EOF",

        // systemd timer for update-tools (daily 03:00)
        "cat <<'EOF' > /etc/systemd/system/update-tools.timer",
        "[Unit]",
        "Description=Run update-tools daily at 03:00",
        "",
        "[Timer]",
        "OnCalendar=*-*-* 03:00:00",
        "Persistent=true",
        "",
        "[Install]",
        "WantedBy=timers.target",
        "EOF",

        // rpm-ostree check only
        "install -d /var/lib/chelipeds",

        "cat <<'EOF' > /usr/local/bin/check-ostree-updates.sh",
        "#!/usr/bin/env bash",
        "set -euo pipefail",
        "mkdir -p /var/lib/chelipeds",
        "rm -f /var/lib/chelipeds/updates-available || true",
        "OUT=$(rpm-ostree upgrade --check || true)",
        "printf '%s\\n' \"$OUT\" > /var/lib/chelipeds/upgrade-check.txt",
        "if echo \"$OUT\" | grep -qi 'AvailableUpdate\\|available update\\|Updates available'; then",
        "  touch /var/lib/chelipeds/updates-available",
        "fi",
        "EOF",
        "chmod +x /usr/local/bin/check-ostree-updates.sh",

        // Expose CHELIPEDS_UPDATES_AVAILABLE
        "cat <<'EOF' > /etc/profile.d/chelipeds-updates.sh",
        "if [ -f /var/lib/chelipeds/updates-available ]; then",
        "  export CHELIPEDS_UPDATES_AVAILABLE=1",
        "else",
        "  export CHELIPEDS_UPDATES_AVAILABLE=0",
        "fi",
        "EOF",

        // systemd service + timer for update-check
        "cat <<'EOF' > /etc/systemd/system/chelipeds-update-check.service",
        "[Unit]",
        "Description=Check for rpm-ostree updates and set flag",
        "",
        "[Service]",
        "Type=oneshot",
        "ExecStart=/usr/local/bin/check-ostree-updates.sh",
        "EOF",

        "cat <<'EOF' > /etc/systemd/system/chelipeds-update-check.timer",
        "[Unit]",
        "Description=Check for rpm-ostree updates every 15 minutes (sets CHELIPEDS_UPDATES_AVAILABLE)",
        "",
        "[Timer]",
        "OnCalendar=*:0/15",
        "Persistent=true",
        "",
        "[Install]",
        "WantedBy=timers.target",
        "EOF",

        // Enable timers + login manager
        "systemctl enable update-tools.timer",
        "systemctl enable chelipeds-update-check.timer",
        "systemctl enable ly.service"
      ]
    }
  ]
}
